<% layout('layout', { title: group.name }) %>

<div class="group-container">
  <div class="group-sidebar">
    <div class="group-header">
      <img src="<%= group.avatar %>" alt="<%= group.name %>" class="group-avatar">
      <h2><%= group.name %></h2>
      <p class="group-description"><%= group.description %></p>
    </div>
    
    <div class="group-members">
      <h3>Members <span>(<%= group.members.length %>)</span></h3>
      
      <div class="member-list">
        <% group.members.forEach(member => { %>
          <div class="member">
            <img src="<%= member.avatar %>" alt="<%= member.username %>" class="avatar">
            <div class="member-info">
              <span class="username"><%= member.username %></span>
              <% if (group.creator.equals(member._id)) { %>
                <span class="role creator">Creator</span>
              <% } else if (group.admins.some(a => a._id.equals(member._id))) { %>
                <span class="role admin">Admin</span>
              <% } %>
            </div>
            
            <% if (isCreator || (isAdmin && !group.creator.equals(member._id))) { %>
              <div class="member-actions">
                <% if (isCreator) { %>
                  <% if (group.admins.some(a => a._id.equals(member._id))) { %>
                    <form action="/groups/<%= group._id %>/toggle-admin" method="POST">
                      <input type="hidden" name="userId" value="<%= member._id %>">
                      <button type="submit" class="btn btn-icon btn-small" title="Demote">
                        <i class="fas fa-user-minus"></i>
                      </button>
                    </form>
                  <% } else { %>
                    <form action="/groups/<%= group._id %>/toggle-admin" method="POST">
                      <input type="hidden" name="userId" value="<%= member._id %>">
                      <button type="submit" class="btn btn-icon btn-small" title="Promote">
                        <i class="fas fa-user-plus"></i>
                      </button>
                    </form>
                  <% } %>
                <% } %>
              </div>
            <% } %>
          </div>
        <% }); %>
      </div>
      
      <% if (isAdmin) { %>
        <div class="add-member">
          <form action="/groups/<%= group._id %>/add-member" method="POST">
            <input type="text" name="username" placeholder="Add member by username" required>
            <button type="submit" class="btn btn-icon btn-small">
              <i class="fas fa-plus"></i>
            </button>
          </form>
        </div>
      <% } %>
    </div>
  </div>
  
  <div class="group-chat">
    <div class="group-chat-header">
      <h3><%= group.name %></h3>
      <div class="group-actions">
        <button class="btn btn-icon"><i class="fas fa-cog"></i></button>
      </div>
    </div>
    
    <div class="messages" id="messages-container">
      <% messages.forEach(message => { %>
        <div class="message <%= message.sender._id.equals(currentUser._id) ? 'sent' : 'received' %>">
          <img src="<%= message.sender.avatar %>" alt="<%= message.sender.username %>" class="avatar">
          <div class="message-content">
            <span class="sender"><%= message.sender.username %></span>
            <p><%= message.content %></p>
            <span class="time"><%= formatTime(message.timestamp) %></span>
          </div>
        </div>
      <% }); %>
    </div>
    
    <div class="message-input">
      <form id="message-form">
        <input type="text" placeholder="Type a message..." autocomplete="off">
        <button type="submit" class="btn btn-icon btn-primary">
          <i class="fas fa-paper-plane"></i>
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const socket = io();
    const messageForm = document.getElementById('message-form');
    const messageInput = messageForm.querySelector('input');
    const messagesContainer = document.getElementById('messages-container');
    
    // Прокрутка вниз при загрузке
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Обработка отправки сообщения
    messageForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const content = messageInput.value.trim();
      
      if (content) {
        socket.emit('group message', {
          groupId: '<%= group._id %>',
          content
        });
        
        messageInput.value = '';
      }
    });
    
    // Получение нового сообщения
    socket.on('group message', (data) => {
      if (data.group === '<%= group._id %>') {
        const messageElement = document.createElement('div');
        messageElement.className = `message ${data.sender === '<%= currentUser._id %>' ? 'sent' : 'received'}`;
        
        messageElement.innerHTML = `
          <img src="${data.sender === '<%= currentUser._id %>' ? '<%= currentUser.avatar %>' : '/images/default-avatar.png'}" 
               alt="${data.sender === '<%= currentUser._id %>' ? '<%= currentUser.username %>' : 'User'}" 
               class="avatar">
          <div class="message-content">
            <span class="sender">${data.sender === '<%= currentUser._id %>' ? 'You' : 'User'}</span>
            <p>${data.content}</p>
            <span class="time">${new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
          </div>
        `;
        
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
    });
  });
</script>
